name: Release

on:
  release:
    types: [created]

jobs:
  discover-architectures:
    name: Discover Architectures
    runs-on: ubuntu-latest
    permissions:
      contents: read
    container:
      image: chocotechnologies/dmod:1.0.3
    outputs:
      architectures: ${{ steps.list-archs.outputs.architectures }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Fetch dmod to discover architectures
        run: |
          mkdir -p build_discovery
          cd build_discovery
          cmake .. -DDMOD_MODE=DMOD_MODULE
      
      - name: List available architectures
        id: list-archs
        run: |
          DMOD_SRC_DIR=$(find build_discovery -path "*/_deps/dmod-src" -type d | head -1)
          
          # Find all architecture configs and create JSON array
          # Replace first slash with dash to create arch names (e.g., armv7/cortex-m4 -> armv7-cortex-m4)
          ARCHS=$(find ${DMOD_SRC_DIR}/configs/arch -name "tools-cfg.cmake" | \
            sed "s|${DMOD_SRC_DIR}/configs/arch/||g" | \
            sed 's|/tools-cfg.cmake||g' | \
            sed 's|/|-|' | \
            jq -R -s -c 'split("\n") | map(select(length > 0))')
          
          echo "Found architectures: $ARCHS"
          echo "architectures=$ARCHS" >> $GITHUB_OUTPUT

  build-release:
    name: Build Release for ${{ matrix.arch_name }}
    needs: discover-architectures
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        arch_name: ${{ fromJson(needs.discover-architectures.outputs.architectures) }}
    
    container:
      image: chocotechnologies/dmod:1.0.3
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build dmffs for ${{ matrix.arch_name }}
        run: |
          set -e
          mkdir -p build_${{ matrix.arch_name }}
          cd build_${{ matrix.arch_name }}
          
          # First run cmake to fetch dependencies
          cmake .. -DDMOD_MODE=DMOD_MODULE -DDMOD_BUILD_TOOLS=ON
          
          # Find dmod source directory and tools config
          DMOD_SRC_DIR=$(find . -path "*/_deps/dmod-src" -type d | head -1)
          
          if [ -z "$DMOD_SRC_DIR" ]; then
            echo "Error: Could not find dmod source directory"
            exit 1
          fi
          
          # Convert arch_name back to path (e.g., armv7-cortex-m4 -> armv7/cortex-m4)
          # Only replace first dash with slash
          ARCH_PATH=$(echo "${{ matrix.arch_name }}" | sed 's|-|/|')
          TOOLS_CFG_PATH="${DMOD_SRC_DIR}/configs/arch/${ARCH_PATH}/tools-cfg.cmake"
          
          if [ ! -f "$TOOLS_CFG_PATH" ]; then
            echo "Error: Tools config file not found at $TOOLS_CFG_PATH"
            exit 1
          fi
          
          echo "Using tools config: $TOOLS_CFG_PATH"
          
          # Reconfigure with architecture-specific tools
          rm -rf CMakeCache.txt CMakeFiles
          cmake .. \
            -DDMOD_MODE=DMOD_MODULE \
            -DDMOD_BUILD_TOOLS=ON \
            -DDMOD_TOOLS="${TOOLS_CFG_PATH}"
          
          # Build the modules
          cmake --build .
          
          echo "Build completed for ${{ matrix.arch_name }}"
          ls -la _deps/dmod-build/dmf/
      
      - name: Prepare release package
        run: |
          set -e
          mkdir -p release_package
          
          # Copy built modules (.dmf files)
          cp build_${{ matrix.arch_name }}/_deps/dmod-build/dmf/dmffs.dmf release_package/
          cp build_${{ matrix.arch_name }}/_deps/dmod-build/dmf/make_dmffs.dmf release_package/
          
          # Copy compressed modules (.dmfc files) if they exist
          if [ -f "build_${{ matrix.arch_name }}/_deps/dmod-build/dmfc/dmffs.dmfc" ]; then
            cp build_${{ matrix.arch_name }}/_deps/dmod-build/dmfc/dmffs.dmfc release_package/
          fi
          if [ -f "build_${{ matrix.arch_name }}/_deps/dmod-build/dmfc/make_dmffs.dmfc" ]; then
            cp build_${{ matrix.arch_name }}/_deps/dmod-build/dmfc/make_dmffs.dmfc release_package/
          fi
          
          # Copy documentation and license
          cp README.md release_package/
          cp LICENSE release_package/
          
          # Create release notes file from GitHub release
          echo "${{ github.event.release.body }}" > release_package/RELEASE_NOTES.txt
          
          echo "Package contents:"
          ls -la release_package/
      
      - name: Create release archive
        run: |
          set -e
          cd release_package
          zip -r ../dmffs-${{ github.event.release.tag_name }}-${{ matrix.arch_name }}.zip .
          cd ..
          echo "Created archive:"
          ls -lh dmffs-*.zip
      
      - name: Upload release asset
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload ${{ github.event.release.tag_name }} \
            dmffs-${{ github.event.release.tag_name }}-${{ matrix.arch_name }}.zip \
            --clobber
