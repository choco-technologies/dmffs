name: Release

on:
  release:
    types: [created]

jobs:
  build-release:
    name: Build Release for ${{ matrix.arch_name }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch_name: x86_64
            container: chocotechnologies/dmod:1.0.2
            install_toolchain: ""
          - arch_name: armv7-cortex-m4
            container: chocotechnologies/dmod:1.0.2
            install_toolchain: "apt-get update && apt-get install -y gcc-arm-none-eabi"
          - arch_name: armv7-cortex-m7
            container: chocotechnologies/dmod:1.0.2
            install_toolchain: "apt-get update && apt-get install -y gcc-arm-none-eabi"
    
    container:
      image: ${{ matrix.container }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install toolchain for ${{ matrix.arch_name }}
        if: matrix.install_toolchain != ''
        run: ${{ matrix.install_toolchain }}
      
      - name: Build dmffs for ${{ matrix.arch_name }}
        run: |
          set -e
          mkdir -p build_${{ matrix.arch_name }}
          cd build_${{ matrix.arch_name }}
          
          # First run cmake to fetch dependencies
          cmake .. -DDMOD_MODE=DMOD_MODULE
          
          # Find dmod source directory and set DMOD_TOOLS if not x86_64
          if [ "${{ matrix.arch_name }}" != "x86_64" ]; then
            DMOD_SRC_DIR=$(find . -path "*/_deps/dmod-src" -type d | head -1)
            
            if [ -z "$DMOD_SRC_DIR" ]; then
              echo "Error: Could not find dmod source directory"
              exit 1
            fi
            
            # Determine the correct tools config path based on architecture
            case "${{ matrix.arch_name }}" in
              armv7-cortex-m4)
                TOOLS_CFG_PATH="${DMOD_SRC_DIR}/configs/arch/armv7/cortex-m4/tools-cfg.cmake"
                ;;
              armv7-cortex-m7)
                TOOLS_CFG_PATH="${DMOD_SRC_DIR}/configs/arch/armv7/cortex-m7/tools-cfg.cmake"
                ;;
              *)
                echo "Error: Unknown architecture ${{ matrix.arch_name }}"
                exit 1
                ;;
            esac
            
            if [ ! -f "$TOOLS_CFG_PATH" ]; then
              echo "Error: Tools config file not found at $TOOLS_CFG_PATH"
              exit 1
            fi
            
            echo "Using tools config: $TOOLS_CFG_PATH"
            
            # Reconfigure with architecture-specific tools
            rm -rf CMakeCache.txt CMakeFiles
            cmake .. \
              -DDMOD_MODE=DMOD_MODULE \
              -DDMOD_TOOLS="${TOOLS_CFG_PATH}"
          fi
          
          # Build the modules
          cmake --build .
          
          echo "Build completed for ${{ matrix.arch_name }}"
          ls -la _deps/dmod-build/dmf/
      
      - name: Prepare release package
        run: |
          set -e
          mkdir -p release_package
          
          # Copy built modules
          cp build_${{ matrix.arch_name }}/_deps/dmod-build/dmf/dmffs.dmf release_package/
          cp build_${{ matrix.arch_name }}/_deps/dmod-build/dmf/make_dmffs.dmf release_package/
          
          # Copy documentation and license
          cp README.md release_package/
          cp LICENSE release_package/
          
          # Create release notes file from GitHub release
          echo "${{ github.event.release.body }}" > release_package/RELEASE_NOTES.txt
          
          echo "Package contents:"
          ls -la release_package/
      
      - name: Create release archive
        run: |
          set -e
          cd release_package
          zip -r ../dmffs-${{ github.event.release.tag_name }}-${{ matrix.arch_name }}.zip .
          cd ..
          echo "Created archive:"
          ls -lh dmffs-*.zip
      
      - name: Upload release asset
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload ${{ github.event.release.tag_name }} \
            dmffs-${{ github.event.release.tag_name }}-${{ matrix.arch_name }}.zip \
            --clobber
